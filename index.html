<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Colorfashion é ç´„ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        :root {
            --primary-color: #9b8c83; /* è«è˜­è¿ªæ£•è‰² (ä¸»è‰²èª¿) */
            --accent-color: #d4a5a5;  /* æŸ”å’Œç²‰ (å¼·èª¿è‰²) */
            --bg-color: #f4f4f4;      /* èƒŒæ™¯è‰² */
            --text-color: #4a4a4a;    /* æ–‡å­—è‰² */
            --card-bg: #ffffff;       /* å¡ç‰‡èƒŒæ™¯ */
            --input-bg: #f8f9fa;      /* è¼¸å…¥æ¡†èƒŒæ™¯ */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* --- å¡ç‰‡å®¹å™¨ --- */
        .container {
            background-color: var(--card-bg);
            width: 100%;
            max-width: 500px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* æŸ”å’Œé™°å½± */
            animation: fadeIn 0.5s ease-out;
        }

        h2 {
            text-align: center;
            color: var(--text-color);
            font-weight: 600;
            margin-bottom: 25px;
            letter-spacing: 1px;
        }

        /* --- è¡¨å–®å…ƒä»¶ --- */
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #666;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid transparent;
            background-color: var(--input-bg);
            border-radius: 12px;
            font-size: 16px; /* é˜²æ­¢ iOS è‡ªå‹•ç¸®æ”¾ */
            color: #333;
            transition: all 0.3s ease;
            box-sizing: border-box;
            appearance: none; /* ç§»é™¤åŸç”Ÿæ¨£å¼ */
        }

        input:focus, select:focus {
            outline: none;
            background-color: #fff;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(212, 165, 165, 0.15);
        }

        /* ä¸‹æ‹‰é¸å–®çš„å°ç®­é ­å„ªåŒ– */
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        button:active {
            transform: scale(0.98);
        }

        #submitBtn {
            background: linear-gradient(135deg, var(--primary-color), #b0a198);
            color: white;
            box-shadow: 0 4px 15px rgba(155, 140, 131, 0.3);
        }

        #submitBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .cancel-btn {
            background-color: transparent;
            color: #e74c3c;
            border: 1px solid #e74c3c;
            margin-top: 15px;
            display: none; /* é è¨­éš±è— */
        }
        
        .cancel-btn:hover {
            background-color: #fff5f5;
        }

        /* --- è¼‰å…¥å‹•ç•« (Loading Overlay) --- */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none; /* é è¨­éš±è— */
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="color: #666; font-size: 14px;">è³‡æ–™è™•ç†ä¸­...</div>
    </div>

    <div class="container">
        <h2 id="pageTitle">Colorfashion é ç´„</h2>

        <form id="bookingForm" onsubmit="submitBooking(event)">
            <input type="hidden" id="editId" name="editId">
            <input type="hidden" id="lineId" name="lineId">

            <div class="form-group">
                <label>å§“å 1</label>
                <input type="text" id="name" required placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
            </div>

            <div class="form-group">
                <label>å§“å 2 (é¸å¡«)</label>
                <input type="text" id="name2" placeholder="å¦‚æœ‰åŒè¡Œè€…è«‹è¼¸å…¥">
            </div>

            <div class="form-group">
                <label>è¯çµ¡é›»è©±</label>
                <input type="tel" id="phone" required placeholder="09xx-xxx-xxx">
            </div>

            <div class="form-group">
                <label>é ç´„æ—¥æœŸ</label>
                <select id="date" required onchange="loadBusyTimes()">
                    <option value="">è¼‰å…¥ä¸­...</option>
                </select>
            </div>

            <div class="form-group">
                <label>é ç´„æ™‚é–“</label>
                <select id="time" required>
                    <option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>
                </select>
            </div>

            <button type="submit" id="submitBtn">ç¢ºèªé ç´„</button>
            <button type="button" id="cancelBtn" class="cancel-btn" onclick="cancelBooking()">å–æ¶ˆæ­¤é ç´„</button>
        </form>
    </div>

    <script>
        // ğŸ”´ è«‹å¡«å…¥ä½ çš„ GAS éƒ¨ç½²ç¶²å€ (çµå°¾æ˜¯ /exec)
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbytizr6IDdZux7gaCZjYqiXVi0uQZELig_xaBagzNyDg84Wfi18IEZSYi7fTk3P3pFB/exec";
        
        // ğŸ”´ è«‹å¡«å…¥ä½ çš„ LIFF ID
        const MY_LIFF_ID = "2009018559-AeGOURPY";

        // âœ… æ™‚é–“é™£åˆ— (å·²ä¿®æ­£æ ¼å¼)
        let availableTimes = ["10:00", "10:30", "11:00", "11:30", "12:00", "12:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30", "17:00", "17:30", "18:00", "18:30", "19:00", "19:30", "20:00"];

        // åˆå§‹åŒ–
        window.onload = async function() {
            setLoading(true);
            try {
                // 1. LIFF åˆå§‹åŒ–
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                document.getElementById('lineId').value = profile.userId;

                // 2. åˆ¤æ–·æ˜¯å¦ç‚ºã€Œä¿®æ”¹/å–æ¶ˆæ¨¡å¼ã€
                const urlParams = new URLSearchParams(window.location.search);
                const editId = urlParams.get('id');

                // 3. è¼‰å…¥ç‡Ÿæ¥­æ—¥
                await loadOpenDates();

                // 4. ä¿®æ”¹æ¨¡å¼è¼‰å…¥èˆŠè³‡æ–™
                if (editId) {
                    document.getElementById('editId').value = editId;
                    document.getElementById('pageTitle').innerText = "ä¿®æ”¹é ç´„";
                    document.getElementById('submitBtn').innerText = "æ›´æ–°é ç´„å…§å®¹";
                    document.getElementById('cancelBtn').style.display = "block";
                    await loadBookingData(editId);
                }

            } catch (err) {
                alert("åˆå§‹åŒ–å¤±æ•—ï¼š" + err.message);
            } finally {
                setLoading(false);
            }
        };

        // API å‘¼å«
        async function callApi(action, payload = {}) {
            const response = await fetch(GAS_API_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify({ action: action, payload: payload })
            });
            return await response.json();
        }

        async function loadOpenDates() {
            const res = await callApi("getInitData");
            const select = document.getElementById('date');
            select.innerHTML = '<option value="">è«‹é¸æ“‡æ—¥æœŸ</option>';
            res.dates.forEach(d => {
                let option = document.createElement("option");
                option.value = d;
                option.text = d;
                select.appendChild(option);
            });
        }

        async function loadBusyTimes() {
            const date = document.getElementById('date').value;
            const timeSelect = document.getElementById('time');
            
            if (!date) {
                timeSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>';
                return;
            }

            timeSelect.innerHTML = '<option value="">æŸ¥è©¢æ™‚æ®µä¸­...</option>';
            timeSelect.disabled = true; // é–å®šç›´åˆ°è¼‰å…¥å®Œæˆ
            
            const res = await callApi("getBusyTimes", { date: date });
            const busyList = res.times || [];
            
            timeSelect.innerHTML = '';
            timeSelect.disabled = false;

            // é è¨­é¸é …
            let defaultOption = document.createElement("option");
            defaultOption.text = "è«‹é¸æ“‡æ™‚é–“";
            defaultOption.value = "";
            timeSelect.appendChild(defaultOption);

            availableTimes.forEach(t => {
                let option = document.createElement("option");
                option.value = t;
                option.text = t;
                if (busyList.includes(t)) {
                    option.disabled = true;
                    option.text += " (é¡æ»¿)";
                    option.style.color = "#ccc"; // è®“é¡æ»¿çš„çœ‹èµ·ä¾†ç°ç°çš„
                }
                timeSelect.appendChild(option);
            });
        }

        async function loadBookingData(id) {
            const res = await callApi("getBooking", { id: id });
            if (res.status === "success") {
                const data = res.data;
                document.getElementById('name').value = data.name;
                document.getElementById('name2').value = data.name2;
                document.getElementById('phone').value = data.phone;
                document.getElementById('date').value = data.date;
                await loadBusyTimes();
                document.getElementById('time').value = data.time;
            } else {
                alert(res.message);
            }
        }

        async function submitBooking(e) {
            e.preventDefault();
            setLoading(true);
            
            const formData = {
                editId: document.getElementById('editId').value,
                lineId: document.getElementById('lineId').value,
                name: document.getElementById('name').value,
                name2: document.getElementById('name2').value,
                phone: document.getElementById('phone').value,
                date: document.getElementById('date').value,
                time: document.getElementById('time').value
            };

            const res = await callApi("submitBooking", formData);
            setLoading(false);
            
            if (res.status === "success") {
                alert(res.message);
                if(liff.isInClient()){
                    liff.closeWindow();
                } else {
                    window.location.reload();
                }
            } else {
                alert("éŒ¯èª¤ï¼š" + res.message);
            }
        }

        async function cancelBooking() {
            if (!confirm("ç¢ºå®šè¦å–æ¶ˆæ­¤é ç´„å—ï¼Ÿ\n(å–æ¶ˆå¾Œç„¡æ³•å¾©åŸ)")) return;
            
            setLoading(true);
            const id = document.getElementById('editId').value;
            const res = await callApi("cancelBooking", { id: id });
            setLoading(false);

            if (res.status === "success") {
                alert(res.message);
                liff.closeWindow();
            } else {
                alert("éŒ¯èª¤ï¼š" + res.message);
            }
        }

        function setLoading(isLoading) {
            const overlay = document.getElementById('loading-overlay');
            const btn = document.getElementById('submitBtn');
            if (isLoading) {
                overlay.style.display = 'flex';
                btn.disabled = true;
            } else {
                overlay.style.display = 'none';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
