<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colorfashion é ç´„ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background-color: #f9f9f9; }
        h2 { text-align: center; color: #333; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; margin-top: 10px; }
        button:disabled { background-color: #ccc; }
        .cancel-btn { background-color: #dc3545; margin-top: 10px; display: none; }
        #loading { text-align: center; display: none; color: #666; }
    </style>
</head>
<body>

    <h2 id="pageTitle">ç·šä¸Šé ç´„</h2>

    <div id="loading">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>

    <form id="bookingForm" onsubmit="submitBooking(event)">
        <input type="hidden" id="editId" name="editId">
        <input type="hidden" id="lineId" name="lineId">

        <div class="form-group">
            <label>å§“å 1</label>
            <input type="text" id="name" required placeholder="è«‹è¼¸å…¥å§“å">
        </div>

        <div class="form-group">
            <label>å§“å 2 (é›™äººé ç´„é¸å¡«)</label>
            <input type="text" id="name2" placeholder="åŒè¡Œè€…å§“å">
        </div>

        <div class="form-group">
            <label>é›»è©±</label>
            <input type="tel" id="phone" required placeholder="09xx...">
        </div>

        <div class="form-group">
            <label>é ç´„æ—¥æœŸ</label>
            <select id="date" required onchange="loadBusyTimes()">
                <option value="">è¼‰å…¥ä¸­...</option>
            </select>
        </div>

        <div class="form-group">
            <label>é ç´„æ™‚é–“</label>
            <select id="time" required>
                <option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>
            </select>
        </div>

        <button type="submit" id="submitBtn">ç¢ºèªé ç´„</button>
        <button type="button" id="cancelBtn" class="cancel-btn" onclick="cancelBooking()">å–æ¶ˆæ­¤é ç´„</button>
    </form>

    <script>
        // ğŸ”´ è«‹å¡«å…¥ä½ çš„ GAS éƒ¨ç½²ç¶²å€ (çµå°¾æ˜¯ /exec)
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzq8QoWuBjWrjvMv6FvsttGmEdHIF9DrsmMQdw9XTfvlT2ywYJUZRnflROibd0kEOQ6/exec";
        
        // ğŸ”´ è«‹å¡«å…¥ä½ çš„ LIFF ID
        const MY_LIFF_ID = "2009018559-AeGOURPY";

        // å…¨åŸŸè®Šæ•¸
        let availableTimes = ["10:00", "10:30", "11:00", "11:30", "12:00", "12:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30", "17:00", "17:30", "18:00"];

        // åˆå§‹åŒ–
        window.onload = async function() {
            setLoading(true);
            try {
                // 1. LIFF åˆå§‹åŒ–
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                document.getElementById('lineId').value = profile.userId;

                // 2. åˆ¤æ–·æ˜¯å¦ç‚ºã€Œä¿®æ”¹/å–æ¶ˆæ¨¡å¼ã€ (ç¶²å€æœ‰ ?id=...)
                const urlParams = new URLSearchParams(window.location.search);
                const editId = urlParams.get('id');

                // 3. è¼‰å…¥ç‡Ÿæ¥­æ—¥
                await loadOpenDates();

                // 4. å¦‚æœæ˜¯ä¿®æ”¹æ¨¡å¼ï¼Œè¼‰å…¥èˆŠè³‡æ–™
                if (editId) {
                    document.getElementById('editId').value = editId;
                    document.getElementById('pageTitle').innerText = "ä¿®æ”¹/å–æ¶ˆé ç´„";
                    document.getElementById('submitBtn').innerText = "æ›´æ–°é ç´„";
                    document.getElementById('cancelBtn').style.display = "block";
                    await loadBookingData(editId);
                }

            } catch (err) {
                alert("åˆå§‹åŒ–å¤±æ•—ï¼š" + err.message);
            } finally {
                setLoading(false);
            }
        };

        // å‘¼å«å¾Œç«¯ API çš„é€šç”¨å‡½å¼
        async function callApi(action, payload = {}) {
            const response = await fetch(GAS_API_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" }, // é¿é–‹ CORS
                body: JSON.stringify({ action: action, payload: payload })
            });
            return await response.json();
        }

        async function loadOpenDates() {
            const res = await callApi("getInitData");
            const select = document.getElementById('date');
            select.innerHTML = '<option value="">è«‹é¸æ“‡æ—¥æœŸ</option>';
            res.dates.forEach(d => {
                let option = document.createElement("option");
                option.value = d;
                option.text = d;
                select.appendChild(option);
            });
        }

        async function loadBusyTimes() {
            const date = document.getElementById('date').value;
            const timeSelect = document.getElementById('time');
            
            if (!date) {
                timeSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>';
                return;
            }

            timeSelect.innerHTML = '<option value="">è®€å–ä¸­...</option>';
            const res = await callApi("getBusyTimes", { date: date });
            
            // éæ¿¾æ‰å·²è¢«é ç´„çš„æ™‚é–“ (å¦‚æœæ˜¯ä¿®æ”¹æ¨¡å¼ï¼Œè¦ä¿ç•™åŸæœ¬è‡ªå·±çš„æ™‚é–“)
            const busyList = res.times || [];
            
            timeSelect.innerHTML = '';
            availableTimes.forEach(t => {
                let option = document.createElement("option");
                option.value = t;
                option.text = t;
                // å¦‚æœè©²æ™‚æ®µå¿™ç¢Œï¼Œå‰‡ç¦ç”¨ (é™¤éæ˜¯ç›®å‰é¸ä¸­çš„æ™‚æ®µ-ç·¨è¼¯æ¨¡å¼ä¸‹)
                if (busyList.includes(t)) {
                    option.disabled = true;
                    option.text += " (å·²é¡æ»¿)";
                }
                timeSelect.appendChild(option);
            });
        }

        async function loadBookingData(id) {
            const res = await callApi("getBooking", { id: id });
            if (res.status === "success") {
                const data = res.data;
                document.getElementById('name').value = data.name;
                document.getElementById('name2').value = data.name2;
                document.getElementById('phone').value = data.phone;
                document.getElementById('date').value = data.date;
                
                // è§¸ç™¼æ™‚é–“è¼‰å…¥ï¼Œä¸¦é é¸åŸæœ¬çš„æ™‚é–“
                await loadBusyTimes();
                document.getElementById('time').value = data.time;
            } else {
                alert(res.message);
            }
        }

        async function submitBooking(e) {
            e.preventDefault();
            setLoading(true);
            
            const formData = {
                editId: document.getElementById('editId').value,
                lineId: document.getElementById('lineId').value,
                name: document.getElementById('name').value,
                name2: document.getElementById('name2').value,
                phone: document.getElementById('phone').value,
                date: document.getElementById('date').value,
                time: document.getElementById('time').value
            };

            const res = await callApi("submitBooking", formData);
            setLoading(false);
            
            if (res.status === "success") {
                alert(res.message);
                if(liff.isInClient()){
                    liff.closeWindow(); // æ‰‹æ©Ÿç‰ˆç›´æ¥é—œé–‰è¦–çª—
                } else {
                    window.location.reload(); // é›»è…¦ç‰ˆé‡æ–°æ•´ç†
                }
            } else {
                alert("éŒ¯èª¤ï¼š" + res.message);
            }
        }

        async function cancelBooking() {
            if (!confirm("ç¢ºå®šè¦å–æ¶ˆæ­¤é ç´„å—ï¼Ÿ")) return;
            
            setLoading(true);
            const id = document.getElementById('editId').value;
            const res = await callApi("cancelBooking", { id: id });
            setLoading(false);

            if (res.status === "success") {
                alert(res.message);
                liff.closeWindow();
            } else {
                alert("éŒ¯èª¤ï¼š" + res.message);
            }
        }

        function setLoading(isLoading) {
            document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
            document.getElementById('submitBtn').disabled = isLoading;
        }
    </script>
</body>
</html>
