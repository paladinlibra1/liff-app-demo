<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Colorfashion é ç´„ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- å…¨åŸŸè¨­å®š (ç²‰è‰²ç³») --- */
        :root {
            --primary-color: #d68095; /* æ«»èŠ±ç²‰ (ä¸»è‰²èª¿) */
            --primary-dark: #c06c82;  /* æ·±ç²‰ç´… (æŒ‰éˆ•æŒ‰å£“) */
            --accent-color: #e8aeb7;  /* æ·ºç²‰ (å¼·èª¿/å¤–æ¡†) */
            --bg-color: #fdf2f5;      /* æ¥µæ·¡ç²‰ç™½èƒŒæ™¯ */
            --text-color: #5d4037;    /* æš–æ£•è‰²æ–‡å­— (æ¯”ç´”é»‘æŸ”å’Œ) */
            --card-bg: #ffffff;       /* å¡ç‰‡èƒŒæ™¯ */
            --input-bg: #fffbfb;      /* è¼¸å…¥æ¡†èƒŒæ™¯ */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* --- å¡ç‰‡å®¹å™¨ --- */
        .container {
            background-color: var(--card-bg);
            width: 100%;
            max-width: 500px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(214, 128, 149, 0.15); /* ç²‰è‰²æŸ”å’Œé™°å½± */
            border: 1px solid #fae1e6;
            animation: fadeIn 0.5s ease-out;
        }

        h2 {
            text-align: center;
            color: var(--primary-dark);
            font-weight: 600;
            margin-bottom: 25px;
            letter-spacing: 1px;
        }

        /* --- è¡¨å–®å…ƒä»¶ --- */
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            color: #8c6b6b; /* è—•ç²‰è‰²æ–‡å­— */
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid transparent;
            background-color: var(--input-bg);
            border-radius: 15px; /* åœ“è§’æ›´åœ“æ½¤ */
            font-size: 16px;
            color: #555;
            transition: all 0.3s ease;
            box-sizing: border-box;
            appearance: none;
            border: 1px solid #f2e1e6;
        }

        input:focus, select:focus {
            outline: none;
            background-color: #fff;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(232, 174, 183, 0.25);
        }

        /* ä¸‹æ‹‰é¸å–®ç®­é ­ (æ”¹ç‚ºç´…æ£•è‰²) */
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23c06c82' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 16px;
        }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        button:active {
            transform: scale(0.98);
        }

        #submitBtn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: 0 6px 20px rgba(214, 128, 149, 0.4);
        }

        #submitBtn:disabled {
            background: #e0d0d5;
            cursor: not-allowed;
            box-shadow: none;
        }

        .cancel-btn {
            background-color: #fff;
            color: #e57373;
            border: 1px solid #ffcdd2;
            margin-top: 15px;
            display: none;
        }
        
        .cancel-btn:hover {
            background-color: #fffafb;
        }

        /* --- Loading --- */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }
        
        .spinner {
            width: 45px;
            height: 45px;
            border: 4px solid #fceef2;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="color: #666; font-size: 14px;">è³‡æ–™è™•ç†ä¸­...</div>
    </div>

    <div class="container">
        <h2 id="pageTitle">Colorfashion é ç´„</h2>

        <form id="bookingForm" onsubmit="submitBooking(event)">
            <input type="hidden" id="editId" name="editId">
            <input type="hidden" id="lineId" name="lineId">

            <div class="form-group">
                <label>é ç´„èº«åˆ†</label>
                <select id="type" required>
                    <option value="æ–°å®¢">æ–°å®¢</option>
                    <option value="èˆŠå®¢">èˆŠå®¢</option>
                    <option value="è¤‡æª¢">è¤‡æª¢</option>
                </select>
            </div>

            <div class="form-group">
                <label>å§“å 1</label>
                <input type="text" id="name" required placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
            </div>

            <div class="form-group">
                <label>å§“å 2 (é¸å¡«)</label>
                <input type="text" id="name2" placeholder="å¦‚æœ‰åŒè¡Œè€…è«‹è¼¸å…¥">
            </div>

            <div class="form-group">
                <label>è¯çµ¡é›»è©±</label>
                <input type="tel" id="phone" required placeholder="09xx-xxx-xxx">
            </div>

            <div class="form-group">
                <label>é ç´„æ—¥æœŸ</label>
                <select id="date" required onchange="loadBusyTimes()">
                    <option value="">è¼‰å…¥ä¸­...</option>
                </select>
            </div>

            <div class="form-group">
                <label>é ç´„æ™‚é–“</label>
                <select id="time" required>
                    <option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>
                </select>
            </div>

            <button type="submit" id="submitBtn">ç¢ºèªé ç´„</button>
            <button type="button" id="cancelBtn" class="cancel-btn" onclick="cancelBooking()">å–æ¶ˆæ­¤é ç´„</button>
        </form>
    </div>

    <script>
        // ğŸ”´ è«‹å¡«å…¥ä½ çš„ GAS éƒ¨ç½²ç¶²å€ (çµå°¾æ˜¯ /exec)
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbytizr6IDdZux7gaCZjYqiXVi0uQZELig_xaBagzNyDg84Wfi18IEZSYi7fTk3P3pFB/exec";
        
        // ğŸ”´ è«‹å¡«å…¥ä½ çš„ LIFF ID
        const MY_LIFF_ID = "2009018559-AeGOURPY";

        // âœ… æ™‚é–“é™£åˆ—
        let availableTimes = ["10:00", "10:30", "11:00", "11:30", "12:00", "12:30", "13:00", "13:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30", "17:00", "17:30", "18:00", "18:30", "19:00", "19:30", "20:00"];

        // åˆå§‹åŒ–
        window.onload = async function() {
            setLoading(true);
            try {
                // 1. LIFF åˆå§‹åŒ–
                await liff.init({ liffId: MY_LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                document.getElementById('lineId').value = profile.userId;

                const urlParams = new URLSearchParams(window.location.search);
                const editId = urlParams.get('id');

                await loadOpenDates();

                if (editId) {
                    document.getElementById('editId').value = editId;
                    document.getElementById('pageTitle').innerText = "ä¿®æ”¹é ç´„";
                    document.getElementById('submitBtn').innerText = "æ›´æ–°é ç´„å…§å®¹";
                    document.getElementById('cancelBtn').style.display = "block";
                    await loadBookingData(editId);
                }
                
                document.getElementById('name2').addEventListener('input', function() {
                    if (window.lastCounts) renderTimeOptions(window.lastCounts);
                });

            } catch (err) {
                alert("åˆå§‹åŒ–å¤±æ•—ï¼š" + err.message);
            } finally {
                setLoading(false);
            }
        };

        async function callApi(action, payload = {}) {
            const response = await fetch(GAS_API_URL, {
                method: "POST",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify({ action: action, payload: payload })
            });
            return await response.json();
        }

        async function loadOpenDates() {
            const res = await callApi("getInitData");
            const select = document.getElementById('date');
            select.innerHTML = '<option value="">è«‹é¸æ“‡æ—¥æœŸ</option>';
            res.dates.forEach(d => {
                let option = document.createElement("option");
                option.value = d;
                option.text = d;
                select.appendChild(option);
            });
        }

        window.lastCounts = {};

        async function loadBusyTimes() {
            const date = document.getElementById('date').value;
            const timeSelect = document.getElementById('time');
            const editId = document.getElementById('editId').value;
            
            if (!date) {
                timeSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>';
                return;
            }

            timeSelect.innerHTML = '<option value="">æŸ¥è©¢æ™‚æ®µä¸­...</option>';
            timeSelect.disabled = true;
            
            const res = await callApi("getBusyTimes", { date: date, excludeId: editId });
            window.lastCounts = res.times || {}; 
            renderTimeOptions(window.lastCounts);
        }

        function renderTimeOptions(counts) {
            const timeSelect = document.getElementById('time');
            const name2 = document.getElementById('name2').value.trim();
            const isTwoPeople = (name2 !== "");
            const currentSelected = timeSelect.value;

            timeSelect.innerHTML = '';
            timeSelect.disabled = false;

            let defaultOption = document.createElement("option");
            defaultOption.text = "è«‹é¸æ“‡æ™‚é–“";
            defaultOption.value = "";
            timeSelect.appendChild(defaultOption);

            availableTimes.forEach((t, index) => {
                let option = document.createElement("option");
                option.value = t;
                option.text = t;
                
                let currentCount = counts[t] || 0;
                let isDisabled = false;
                let statusText = "";

                if (!isTwoPeople) {
                    if (currentCount >= 2) {
                        isDisabled = true;
                        statusText = " (é¡æ»¿)";
                    } else if (currentCount === 1) {
                        statusText = " (å‰©1ä½)";
                    }
                } else {
                    if (currentCount === 0) {
                        isDisabled = false;
                    } else if (currentCount === 1) {
                        let nextTime = availableTimes[index + 1];
                        if (nextTime) {
                            let nextCount = counts[nextTime] || 0;
                            if (nextCount < 2) {
                                isDisabled = false; 
                                statusText = " (éœ€åˆ†æ™‚æ®µ)"; 
                            } else {
                                isDisabled = true;
                                statusText = " (ç„¡æ³•é€£çºŒ)";
                            }
                        } else {
                            isDisabled = true;
                            statusText = " (é¡æ»¿)";
                        }
                    } else {
                        isDisabled = true;
                        statusText = " (é¡æ»¿)";
                    }
                }

                if (isDisabled) {
                    option.disabled = true;
                    option.text += statusText;
                    option.style.color = "#ccc";
                } else {
                    option.text += statusText;
                }
                timeSelect.appendChild(option);
            });

            if (currentSelected) timeSelect.value = currentSelected;
        }

        async function loadBookingData(id) {
            const res = await callApi("getBooking", { id: id });
            if (res.status === "success") {
                const data = res.data;
                document.getElementById('name').value = data.name;
                document.getElementById('name2').value = data.name2;
                document.getElementById('phone').value = data.phone;
                document.getElementById('date').value = data.date;
                // ğŸ”¥ æ–°å¢ï¼šé å¡«èº«åˆ†
                document.getElementById('type').value = data.type; 
                await loadBusyTimes();
                document.getElementById('time').value = data.time;
            } else {
                alert(res.message);
            }
        }

        async function submitBooking(e) {
            e.preventDefault();
            setLoading(true);
            
            const formData = {
                editId: document.getElementById('editId').value,
                lineId: document.getElementById('lineId').value,
                // ğŸ”¥ æ–°å¢ï¼šå‚³é€èº«åˆ†
                type: document.getElementById('type').value, 
                name: document.getElementById('name').value,
                name2: document.getElementById('name2').value,
                phone: document.getElementById('phone').value,
                date: document.getElementById('date').value,
                time: document.getElementById('time').value
            };

            const res = await callApi("submitBooking", formData);
            setLoading(false);
            
            if (res.status === "success") {
                alert(res.message);
                if(liff.isInClient()){
                    liff.closeWindow();
                } else {
                    window.location.reload();
                }
            } else {
                alert("éŒ¯èª¤ï¼š" + res.message);
            }
        }

        async function cancelBooking() {
            if (!confirm("ç¢ºå®šè¦å–æ¶ˆæ­¤é ç´„å—ï¼Ÿ\n(å–æ¶ˆå¾Œç„¡æ³•å¾©åŸ)")) return;
            setLoading(true);
            const id = document.getElementById('editId').value;
            const res = await callApi("cancelBooking", { id: id });
            setLoading(false);
            if (res.status === "success") {
                alert(res.message);
                if(liff.isInClient()) liff.closeWindow();
                else window.location.href = window.location.pathname;
            } else {
                alert("éŒ¯èª¤ï¼š" + res.message);
            }
        }

        function setLoading(isLoading) {
            const overlay = document.getElementById('loading-overlay');
            const btn = document.getElementById('submitBtn');
            if (isLoading) {
                overlay.style.display = 'flex';
                btn.disabled = true;
            } else {
                overlay.style.display = 'none';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
